<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="http://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

<!-- Create an element where the map will take place -->
<!-- <svg id="my_dataviz" width="2000" height="500"></svg> -->
<!--<svg id="my_dataviz" viewBox="0 0 1010 666" >-->

{% extends "layout_side_nav.html" %}
{% block content %}


<div class = "container-fluid" style="margin-top:50px">
  <div class = "row" style="height: 500"> 
    <div class = "col-2">
      <div id="chart"></div>
    </div>
    <div class = "col-8">
        <div class = "row">
          <div id="sliderContainer">
          <input id="timeslide" type="range" min="1970" max="2017" value="1970" step="1"/><br>
          <span id="range">1970</span>
          </div>
        </div>
        <div class = "space"></div>
        <div class = "row">
          <div id = "Button">
            <select id = "selectButton">
                <option value="num_attacks">Attacks</option>
                <option value="num_deaths">Deaths</option>
            </select>
          </div>
        </div>
        <div class = "space"></div>
        <div class = "row" style="margin-top:"> 
          <div id = "scatterBox">
            <input type="checkbox" name="scatter" value="scatter"  id = "scatter">
            <label for="label1"> Scatter plot</label><br>
          </div>
        </div>
    </div>

    </div>

    
</div>

<div class = "container-fluid" style="margin-top:500px">

    <div class = "row"> 
        <div class = "col-2">
            <div id="barRace">
              <!-- <script type = "text/javascript" src="http://localhost:63342/CS526_DIVA/app/templates/bar_race_chart.html?_ijt=i22d92gn3ct4mqk0cl4gur82sb">
              </script> -->
            </div>
        </div>

        <div class = "col-8">
          <div id = "scatterbox">
              <input type="checkbox" name="scatter" value="scatter"  id = "scatter">
              <label for="label1"> Scatter plot</label><br>
            </div>
        </div>
    </div>
</div>



<style>
          .space{
            min-height: 20px;
          }


        #chart {
            position: fixed;
            /*left: 100px;
            top: 250px;
            bottom: 0px;  */
      }
      </style>

<script>

  var chartDiv = document.getElementById("chart");
  var width = 2000
  var height = 500


  // Map and projection
  var path = d3.geoPath();
  var projection = d3.geoMercator()
                      // .scale(70)
                      .center([0,20])
                      .translate([width / 2, height / 2]);

  // Data and color scale
  var data = d3.map();
  var data_attacks = d3.map();
  var data_deaths = d3.map();
  var colorScale = d3.scaleThreshold()
    <!--.domain([1, 10, 100, 300, 1000, 5000])-->
    .domain([1, 5, 10, 15, 20, 25, 30])
    .range(d3.schemeBlues[7]);

  // var markers = {};
  // var markers = d3.map();
  // markers = d3.map();
  markers = []
  // Load external data and boot
  d3.queue()
    .defer(d3.json, "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
    .defer(d3.csv, "{{url_for('get_csv_data_dropdown')}}", function(d) { 
                                                      data_attacks.set([d.name, d.iyear], +d.num_attacks);
                                                      data_deaths.set([d.name, d.iyear], +d.num_deaths) ;
                                                      // console.log(data_attacks);
                                                                  // markers.set([d.long, d.lat], +[d.long, d.lat]);
                                                                  // markers.append({long : d.long, lat : d.lat});
                                                                   })
    .defer(d3.csv, "{{url_for('get_csv_data_scatter')}}", function(d) {
                                                      // data_attacks.set([d.name, d.iyear], +d.num_attacks);
                                                      // data_deaths.set([d.name, d.iyear], +d.num_deaths) ;
                                                      // markers.set([d.long, d.lat], +d.iyear);
                                                      markers.push({long : d.long , lat : d.lat})
                                                      // markers = d3.autoType
                                                      // console.log(markers);
                                                                  // markers.set([d.long, d.lat], +[d.long, d.lat]);
                                                                  // markers.append({long : d.long, lat : d.lat});
                                                                   })
    .await(ready);


  tooltip = d3.select("body")
              .append("div")
              .style("position", "absolute")
              .style("z-index", "10")
              .style("visibility", "hidden")
              .style("background", "#101820FF ")
              .style("color", "white")
              .style("width", "120px")
              .style("text-align", "center")
              .style("border-radius", "6px")
              .style("padding", "5px", "0")
              .style("font-size", "12px")
              .text("a simple tooltip");



  function ready(error, topo) {

    let mouseOver = function(d) {
            d3.selectAll(".Country")
              .transition()
              .duration(200)
              .style("opacity", .5)

            d3.select(this)
              .transition()
              .duration(200)
              .style("opacity", 1)
              .style("stroke", "black")

            var dropdown = document.getElementById("selectButton").value

            tooltip.text("Country : " + d.properties.name + "   " + dropdown + " : " + d.total );
      
      return tooltip.style("visibility", "visible")
    }

    let mouseLeave = function(d) {
            d3.selectAll(".Country")
              .transition()
              .duration(200)
              .style("opacity", .8)
            d3.select(this)
              .transition()
              .duration(200)
              .style("stroke", "transparent")

            tooltip.style("visibility", "hidden")
    }




    var svg = d3.select(chartDiv).append("svg");

    // Extract the width and height that was computed by CSS.
    // var width = chartDiv.clientWidth;
    // var height = chartDiv.clientHeight;

    // Use the extracted size to set the size of an SVG element.
    

    
    svg
    .attr("width", width)
    .attr("height", height);


    // var svg = d3.select("svg"),
    // width = +svg.attr("width"),
    // height = +svg.attr("height");





    // Draw the map
    svg.append("g")
        .selectAll("path")
        .data(topo.features)
        .enter()
        .append("path")
        // draw each country
        .attr("d", d3.geoPath().projection(projection))
        // set the color of each country
        .attr("fill", function (d) {
          d.total = data_attacks.get([d.properties.name, "1970"]) || 0;
          return colorScale(d.total);
        })
        .style("stroke", "transparent")
        .attr("class", function(d){ return "Country" } )
        .style("opacity", .8)
        .on("mouseover", mouseOver )
        .on("mouseleave", mouseLeave )
        .on("mousemove", function(){return tooltip.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})


    d3.select("#timeslide").on("input", function() {
      update(+this.value);
      });

      // update the fill of each SVG of class "incident" with value
      function update(value) {

              document.getElementById("range").innerHTML = value;

              var dropdown = document.getElementById("selectButton").value
              if (dropdown == "num_attacks"){
                  data = data_attacks;
              } else {
                  data = data_deaths;
              }
              d3.selectAll(".Country")
                  .transition().duration(250)
                  .attr("fill", function (d) {
                      d.total = data.get([d.properties.name, value]) || 0;
                      return colorScale(d.total);
                  })

      }

      d3.select("#selectButton")
        .on("input", function() {
              updateDropDown(this.value);
           });

      function updateDropDown(value) {

            document.getElementById("selectButton").value = value;

            if (value == "num_attacks"){
              data = data_attacks;
            } else {
              data = data_deaths;
            }

            var year = document.getElementById("range").innerHTML

            d3.selectAll(".Country")
                .transition().duration(250)
                .attr("fill", function (d) {
                    d.total = data.get([d.properties.name, year]) || 0;
                    return colorScale(d.total);
              })
      }

      d3.select("#scatter")
        .on("input", function() {
              updateScatter();
           });

      function updateScatter(){
        if(document.getElementById("scatter").checked == true){
          d3.selectAll("circles")
            .data(markers)
            .enter()
            .append("circle")
            .attr("cx", function(d){ return projection([d.long, d.lat])[0] })
            .attr("cy", function(d){ return projection([d.long, d.lat])[1] })
            .attr("r", 4)
            .style("fill", "69b3a2")
            .attr("stroke", "#69b3a2")
            .attr("stroke-width", 3)
            .attr("fill-opacity", .4)

        }

        else{
          d3.selectAll("circles")
            .data(markers)
            .enter()
            .append("circle")
            .attr("cx", function(d){ return 0 })
            .attr("cy", function(d){ return 1 })
            .attr("r", 0)
            
        }
      }

  }

      // redraw();
      // // Redraw based on the new size whenever the browser window is resized.
      // window.addEventListener("resize", redraw);
 
</script>




<script>

var barDiv = document.getElementById("barRace");
var width = 2000;
var height = 500;


// d3 = require("d3@5", "d3-array@2");
// data = d3.csvParse('race1.csv', d3.autoType)
var data = []
d3.queue()
    .defer(d3.json, "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
    .defer(d3.csv, "{{url_for('get_csv_bar_race')}}", function(d) {
                                                      data.push({name : d.name, data : d.date, 
                                                                  value : d.num_attacks})
                                                                   })
    .await(ready);

// viewof replay = html`<button>Replay`


// bar_chart : {
//     // replay;

//     // var svg = d3.select(barDiv).append("svg");
//     // svg.attr("width", width)
//     //     .attr("height", height);
//     const svg = d3.create("svg");
  
//     const updateBars = bars(svg);
//     const updateAxis = axis(svg);
//     const updateLabels = labels(svg);
//     const updateTicker = ticker(svg);

//     yield svg.node();

//     for (const keyframe of keyframes) {
//       const transition = svg.transition()
//                   .duration(duration)
//                   .ease(d3.easeLinear);

//       // Extract the top barâ€™s value.
//       x.domain([0, keyframe[1][0].value]);

//       updateAxis(keyframe, transition);
//       updateBars(keyframe, transition);
//       updateLabels(keyframe, transition);
//       updateTicker(keyframe, transition);

//       invalidation.then(() => svg.interrupt());
//       await transition.end();
//     }
// }

// duration = 250
// n = 12
// names = new Set(data.map(d => d.name))

// datevalues = Array.from(d3.rollup(data, ([d]) => d.value, d => +d.date, d => d.name))
//   .map(([date, data]) => [new Date(date), data])
//   .sort(([a], [b]) => d3.ascending(a, b))

// function rank(value) {
//     const data = Array.from(names, name => ({name, value: value(name)}));
//     data.sort((a, b) => d3.descending(a.value, b.value));
//     for (let i = 0; i < data.length; ++i) data[i].rank = Math.min(n, i);
//     return data;
// }

// k = 10

// keyframes : {
//     const keyframes = [];
//     let ka, a, kb, b;
//     for ([[ka, a], [kb, b]] of d3.pairs(datevalues)) {
//       for (let i = 0; i < k; ++i) {
//         const t = i / k;
//         keyframes.push([ new Date(ka * (1 - t) + kb * t),
//           rank(name => (a.get(name) || 0) * (1 - t) + (b.get(name) || 0) * t)
//         ]);
//       }
//     }
//     keyframes.push([new Date(kb), rank(name => b.get(name) || 0)]);
//     return keyframes;
// }

// nameframes = d3.groups(keyframes.flatMap(([, data]) => data), d => d.name)
// prev = new Map(nameframes.flatMap(([, data]) => d3.pairs(data, (a, b) => [b, a])))
// next = new Map(nameframes.flatMap(([, data]) => d3.pairs(data)))

// function bars(svg) {
//     let bar = svg.append("g")
//         .attr("fill-opacity", 0.6)
//       .selectAll("rect");
  
//     return ([date, data], transition) => bar = bar
//       .data(data.slice(0, n), d => d.name)
//       .join(
//         enter => enter.append("rect")
//           .attr("fill", color)
//           .attr("height", y.bandwidth())
//           .attr("x", x(0))
//           .attr("y", d => y((prev.get(d) || d).rank))
//           .attr("width", d => x((prev.get(d) || d).value) - x(0)),
//         update => update,
//         exit => exit.transition(transition).remove()
//           .attr("y", d => y((next.get(d) || d).rank))
//           .attr("width", d => x((next.get(d) || d).value) - x(0))
//       )
//       .call(bar => bar.transition(transition)
//         .attr("y", d => y(d.rank))
//         .attr("width", d => x(d.value) - x(0)));
//   }

//     function labels(svg) {
//         let label = svg.append("g")
//             .style("font", "bold 12px var(--sans-serif)")
//             .style("font-variant-numeric", "tabular-nums")
//             .attr("text-anchor", "end")
//             .selectAll("text");
    
//         return ([date, data], transition) => label = label
//         .data(data.slice(0, n), d => d.name)
//         .join(
//             enter => enter.append("text")
//                 .attr("transform", d => `translate(${x((prev.get(d) || d).value)},${y((prev.get(d) || d).rank)})`)
//                 .attr("y", y.bandwidth() / 2)
//                 .attr("x", -6)
//                 .attr("dy", "-0.25em")
//                 .text(d => d.name)
//                 .call(text => text.append("tspan")
//                 .attr("fill-opacity", 0.7)
//                 .attr("font-weight", "normal")
//                 .attr("x", -6)
//                 .attr("dy", "1.15em")),
//             update => update,
//             exit => exit.transition(transition).remove()
//             .attr("transform", d => `translate(${x((next.get(d) || d).value)},${y((next.get(d) || d).rank)})`)
//             .call(g => g.select("tspan").tween("text", d => textTween(d.value, (next.get(d) || d).value)))
//         )
//         .call(bar => bar.transition(transition)
//             .attr("transform", d => `translate(${x(d.value)},${y(d.rank)})`)
//             .call(g => g.select("tspan").tween("text", d => textTween((prev.get(d) || d).value, d.value))));
//     }

//   function textTween(a, b) {
//     const i = d3.interpolateNumber(a, b);
//     return function(t) {
//       this.textContent = formatNumber(i(t));
//     };
//   }

//   formatNumber = d3.format(",d")

//   function axis(svg) {
//     const g = svg.append("g")
//         .attr("transform", `translate(0,${margin.top})`);
  
//     const axis = d3.axisTop(x)
//         .ticks(width / 160)
//         .tickSizeOuter(0)
//         .tickSizeInner(-barSize * (n + y.padding()));
  
//     return (_, transition) => {
//       g.transition(transition).call(axis);
//       g.select(".tick:first-of-type text").remove();
//       g.selectAll(".tick:not(:first-of-type) line").attr("stroke", "white");
//       g.select(".domain").remove();
//     };
//   }

//   function ticker(svg) {
//     const now = svg.append("text")
//         .style("font", `bold ${barSize}px var(--sans-serif)`)
//         .style("font-variant-numeric", "tabular-nums")
//         .attr("text-anchor", "end")
//         .attr("x", width - 6)
//         .attr("y", margin.top + barSize * (n - 0.45))
//         .attr("dy", "0.32em")
//         .text(formatDate(keyframes[0][0]));
  
//     return ([date], transition) => {
//       transition.end().then(() => now.text(formatDate(date)));
//     };
//   }
//   formatDate = d3.utcFormat("%Y")

//   color : {
//     const scale = d3.scaleOrdinal(d3.schemeTableau10);
//     if (data.some(d => d.category !== undefined)) {
//       const categoryByName = new Map(data.map(d => [d.name, d.category]))
//       scale.domain(Array.from(categoryByName.values()));
//       return d => scale(categoryByName.get(d.name));
//     }
//     return d=> {scale(d.name);
//   }
    


//   x = d3.scaleLinear([0, 1], [margin.left, width - margin.right])
//   y = d3.scaleBand()
//     .domain(d3.range(n + 1))
//     .rangeRound([margin.top, margin.top + barSize * (n + 1 + 0.1)])
//     .padding(0.1)

//   height = margin.top + barSize * n + margin.bottom
//   barSize = 48
//   margin = ({top: 16, right: 6, bottom: 6, left: 0})
 
</script>
{% endblock %}
